<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orion Price | Эксклюзивный Калькулятор Услуг</title>
  
  <!-- Загрузка необходимых библиотек -->
  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Tailwind CSS для стилей -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap');
    
    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Manrope', sans-serif;
      background-color: #0A0C10; /* Еще более глубокий темный фон */
      color: #E6EDF3; /* Мягкий белый текст */
    }

    /* --- Анимированный градиент для заголовка --- */
    .animated-gradient-text {
      background: linear-gradient(90deg, #A371F7, #F778BA, #F7B731, #3FB950, #58A6FF, #A371F7);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradient-animation 10s ease infinite;
    }

    @keyframes gradient-animation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* --- Эффект "Аврора" для шапки --- */
    .header-aurora {
      position: relative;
      overflow: hidden;
    }

    .header-aurora::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(120deg, rgba(163, 113, 247, 0.05) 0%, rgba(247, 120, 186, 0.05) 50%, rgba(88, 166, 255, 0.05) 100%);
        background-size: 300% 300%;
        animation: aurora-animation 20s ease infinite;
        z-index: -1;
    }

    @keyframes aurora-animation {
        0%{background-position:0% 50%}
        50%{background-position:100% 50%}
        100%{background-position:0% 50%}
    }

    /* Кастомные цвета для категорий */
    .border-cat-sro { border-color: #58A6FF; } .accent-cat-sro { background-color: #58A6FF; } .text-cat-sro { color: #58A6FF; }
    .border-cat-nrs { border-color: #3FB950; } .accent-cat-nrs { background-color: #3FB950; } .text-cat-nrs { color: #3FB950; }
    .border-cat-nok { border-color: #F7B731; } .accent-cat-nok { background-color: #F7B731; } .text-cat-nok { color: #F7B731; }
    .border-cat-edu { border-color: #A371F7; } .accent-cat-edu { background-color: #A371F7; } .text-cat-edu { color: #A371F7; }
    .border-cat-lic { border-color: #F778BA; } .accent-cat-lic { background-color: #F778BA; } .text-cat-lic { color: #F778BA; }
    .border-cat-iso { border-color: #D2A8FF; } .accent-cat-iso { background-color: #D2A8FF; } .text-cat-iso { color: #D2A8FF; }
    .border-cat-vik { border-color: #79C0FF; } .accent-cat-vik { background-color: #79C0FF; } .text-cat-vik { color: #79C0FF; }
    .border-cat-sout { border-color: #8B949E; } .accent-cat-sout { background-color: #8B949E; } .text-cat-sout { color: #8B949E; }

    /* Кастомные стили для слайдеров */
    .custom-range {
      -webkit-appearance: none; appearance: none; height: 4px; border-radius: 2px;
      background: #30363d; outline: none; transition: all 0.3s ease;
    }
    .custom-range::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 18px; height: 18px;
      border-radius: 50%; background: #F7B731; cursor: pointer;
      box-shadow: 0 0 8px rgba(247, 183, 49, 0.5); transition: all 0.3s ease; border: none;
    }
    .custom-range::-moz-range-thumb {
      width: 18px; height: 18px; border-radius: 50%; background: #F7B731;
      cursor: pointer; border: none; box-shadow: 0 0 8px rgba(247, 183, 49, 0.5);
    }
    
    /* Анимации */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    
    /* Карточки и контейнеры */
    .premium-card {
      background-color: #161B22; border: 1px solid #30363d; border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4); transition: all 0.3s ease-in-out;
    }
    .premium-card:hover { border-color: #8B949E; }
    .service-card {
      background-color: #161B22; border-left: 4px solid; border-radius: 12px;
      transition: all 0.3s ease-in-out;
    }
    .service-card:hover { background-color: #21262d; transform: translateY(-2px); }
    
    /* Селекты */
    .custom-select {
      background-color: #21262d; border: 1px solid #30363d; color: #E6EDF3;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23F7B731' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center; background-repeat: no-repeat;
      background-size: 1.5em 1.5em; padding-right: 2.5rem; transition: all 0.2s ease-in-out;
    }
    .custom-select:focus {
      outline: none; border-color: #F7B731; box-shadow: 0 0 0 3px rgba(247, 183, 49, 0.3);
    }

    /* Уведомления */
    .notification {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      z-index: 1000; animation: fadeIn 0.5s ease-out; background-color: #21262d;
      border: 1px solid #F7B731; color: #E6EDF3; border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.7);
    }

    /* Стиль для подсветки себестоимости */
    .cost-highlight {
      background-color: rgba(212, 57, 57, 0.1); padding: 8px 12px;
      margin: -8px -12px; border-radius: 8px;
    }

    /* Кастомный скроллбар для корзины */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #161B22; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #8B949E; }

  </style>
</head>
<body class="min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    // --- SVG Иконки ---
    const icons = {
      sro: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clipRule="evenodd" /></svg>,
      nrs: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>,
      nok: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3.5a1 1 0 00.002 1.84L10 10.5l7.394-3.08a1 1 0 00.002-1.84l-7-3.5zM3 9.563l7 3.438 7-3.438V12a1 1 0 01-2 0v-1.563l-5 2.083-5-2.083V12a1 1 0 01-2 0V9.563z" /></svg>,
      edu: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0114.5 16c1.255 0 2.443-.29 3.5-.804v-10A7.968 7.968 0 0014.5 4z" /></svg>,
      lic: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clipRule="evenodd" /></svg>,
      iso: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>,
      vik: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd" /></svg>,
      sout: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 1.944A11.954 11.954 0 012.166 5.023L2 5.033v4.286c0 .635.166 1.258.475 1.824l3.198 4.684a1 1 0 001.644-.006l3.198-4.684A2.98 2.98 0 0012 9.32V5.032l-.165-.009A11.954 11.954 0 0110 1.944zM8 8a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clipRule="evenodd" /></svg>,
      search: <svg className="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
      cart: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>,
      proposal: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
      copy: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
      back: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>,
      emptyCart: <svg className="w-24 h-24 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>,
      clear: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
    };

    // Основной компонент приложения
    const ServiceCalculator = () => {
      const [services, setServices] = React.useState([]);
      const [selectedServices, setSelectedServices] = React.useState([]);
      const [totalPrice, setTotalPrice] = React.useState(0);
      const [totalCostPrice, setTotalCostPrice] = React.useState(0);
      const [totalMargin, setTotalMargin] = React.useState(0);
      const [activeCategory, setActiveCategory] = React.useState(null);
      const [searchTerm, setSearchTerm] = React.useState('');
      const [showProposal, setShowProposal] = React.useState(false);
      const [proposalText, setProposalText] = React.useState('');
      const [notification, setNotification] = React.useState('');
      const proposalRef = React.useRef(null);
      const servicesListRef = React.useRef(null);

      // Данные по услугам
      React.useEffect(() => {
        const servicesData = [
          { category: 'СРО', icon: icons.sro, color: 'sro', items: [ { id: 'sro1', name: 'Подготовка документов для допуска СРО (по юридическому адресу)', note: 'Обычные регионы, срок от 1 недели', costPrice: 5000, lowerPrice: 20000, upperPrice: 35000, minMargin: 15000, fee: '', quantity: 1, region: 'Обычные регионы', regions: ['Обычные регионы', 'Сложные регионы (Оренбург, Тюмень и др.)'], priceByRegion: { 'Обычные регионы': { lower: 20000, upper: 35000, cost: 5000 }, 'Сложные регионы (Оренбург, Тюмень и др.)': { lower: 35000, upper: 40000, cost: 10000 } }, noteByRegion: { 'Обычные регионы': 'Обычные регины, срок от 1 недели', 'Сложные регионы (Оренбург, Тюмень и др.)': 'Сложные регионы, срок от 1 недели' }, regionNotes: { 'Обычные регионы': '', 'Сложные регионы (Оренбург, Тюмень и др.)': 'Оренбург, Тюмень, Кемерово, Челябинск, Калининград, Астрахань' } } ] },
          { category: 'НРС', icon: icons.nrs, color: 'nrs', items: [ { id: 'nrs1', name: 'Подбор и предоставление специалиста, включенного в НРС НОСТРОЙ / НОПРИЗ с оригиналом ТК и ЭТК', note: 'Срок реализации 3-7 рабочих дней', costPrice: 15000, lowerPrice: 40000, upperPrice: 50000, minMargin: 25000, fee: 'МРОТ', quantity: 1, region: 'Обычные регионы', regions: ['Обычные регионы', 'Сложные регионы (Оренбург, Тюмень и др.)'], priceByRegion: { 'Обычные регионы': { lower: 40000, upper: 50000, cost: 15000 }, 'Сложные регионы (Оренбург, Тюмень и др.)': { lower: 60000, upper: 75000, cost: 25000 } }, noteByRegion: { 'Обычные регионы': 'Срок реализации 3-7 рабочих дней', 'Сложные регионы (Оренбург, Тюмень и др.)': 'Срок реализации 3-7 рабочих дней' }, regionNotes: { 'Обычные регионы': '', 'Сложные регионы (Оренбург, Тюмень и др.)': 'Оренбург, Тюмень, Кемерово, Челябинск, Калининград, Астрахань' } }, { id: 'nrs2', name: 'Подбор специалиста в НРС НОСТРОЙ только УрСиб, без выплаты ему ЗП', note: 'на 12 месяцев одного специалиста (либо до ближайшей проверки СРО с уменьшением стоимости услуги)', costPrice: 35000, lowerPrice: 180000, upperPrice: 195000, minMargin: 145000, fee: '', quantity: 1 }, { id: 'nrs3', name: 'Подбор специалиста в НРС НОСТРОЙ, без выплаты ему ЗП', note: 'на 12 месяцев одного специалиста (либо до ближайшей проверки СРО с уменьшением стоимости услуги)', costPrice: 40000, lowerPrice: 80000, upperPrice: 120000, minMargin: 40000, fee: '', quantity: 1 }, { id: 'nrs4', name: 'Подбор и предоставление специалиста для ОПО', note: 'на 12 месяцев одного специалиста (либо до ближайшей проверки СРО с уменьшением стоимости услуги)', costPrice: 15000, lowerPrice: 35000, upperPrice: 50000, minMargin: 20000, fee: 'МРОТ', quantity: 1 }, { id: 'nrs5', name: 'Подготовка документов для внесения в НРС', note: 'Запросить справку о несудимости, стаж и диплом, НОК, срок 5 рабочих дней', costPrice: 5000, lowerPrice: 15000, upperPrice: 25000, minMargin: 10000, fee: '', quantity: 1 } ] },
          { category: 'НОК', icon: icons.nok, color: 'nok', items: [ { id: 'nok1', name: 'НОК (Независимая оценка квалификаций) НОСТРОЙ', subItems: [ { id: 'nok1_1', name: 'Сдача экзамена по билету (база) по месту пребывания', costPrice: 9000, lowerPrice: 35000, upperPrice: 50000, minMargin: 26000, fee: 'госпошлина 24000', quantity: 1 }, { id: 'nok1_2', name: 'Сдача экзамена по закрепленному билету', costPrice: 15000, lowerPrice: 40000, upperPrice: 55000, minMargin: 25000, fee: 'госпошлина 24000', quantity: 1 }, { id: 'nok1_3', name: 'Гарантия сдачи с прибытием в город', costPrice: 25000, lowerPrice: 65000, upperPrice: 80000, minMargin: 40000, fee: 'госпошлина 24000', quantity: 1, city: 'Ростов-на-Дону', cities: { 'Ростов-на-Дону': { cost: 25000, lower: 65000, upper: 80000, margin: 40000 }, 'Краснодар': { cost: 25000, lower: 65000, upper: 80000, margin: 40000 }, 'Калининград': { cost: 25000, lower: 65000, upper: 80000, margin: 40000 }, 'Сыктывкар': { cost: 25000, lower: 65000, upper: 80000, margin: 40000 }, 'Москва': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 }, 'Санкт-Петербург': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 }, 'Красногорск': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 }, 'Реутов': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 }, 'Уфа': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 }, 'Казань': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 }, 'Сочи': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 }, 'Хабаровск': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 }, 'Челябинск': { cost: 25000, lower: 65000, upper: 70000, margin: 40000 }, 'Екатеринбург': { cost: 25000, lower: 65000, upper: 70000, margin: 40000 }, 'Адлер': { cost: 25000, lower: 65000, upper: 70000, margin: 40000 }, 'Лениногорск': { cost: 25000, lower: 65000, upper: 70000, margin: 40000 }, 'Нижний Новгород': { cost: 25000, lower: 65000, upper: 70000, margin: 40000 }, 'Курган': { cost: 35000, lower: 75000, upper: 90000, margin: 40000 } } } ]}, { id: 'nok2', name: 'НОК (Независимая оценка квалификации) НОПРИЗ', subItems: [ { id: 'nok2_1', name: 'Билет для сдачи без подготовки портфолио, портфолио ваш', costPrice: 9000, lowerPrice: 40000, upperPrice: 55000, minMargin: 31000, fee: 'госпошлина 22000', quantity: 1 }, { id: 'nok2_2', name: 'Сдача экзамена по закрепленному билету', costPrice: 15000, lowerPrice: 40000, upperPrice: 55000, minMargin: 25000, fee: 'госпошлина 22000', quantity: 1 }, { id: 'nok2_3', name: 'Гарантия сдачи с прибытием в город', costPrice: 29000, lowerPrice: 65000, upperPrice: 80000, minMargin: 36000, fee: 'госпошлина 22000', quantity: 1, city: 'Москва', cities: { 'Москва': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 }, 'Санкт-Петербург': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 }, 'Красногорск': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 }, 'Уфа': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 }, 'Казань': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 }, 'Адлер': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 } } } ]}, { id: 'nok3', name: 'НОК для специалиста по строительству особо опасных, технически сложных и уникальных объектов', subItems: [ { id: 'nok3_1', name: 'Гарантия, сдача в городе', costPrice: 29000, lowerPrice: 65000, upperPrice: 80000, minMargin: 36000, fee: 'госпошлина 24000', quantity: 1, city: 'Москва', cities: { 'Москва': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 }, 'Санкт-Петербург': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 }, 'Уфа': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 }, 'Казань': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 } } } ]}, { id: 'nok4', name: 'НОК для специалиста по проектированию особо опасных, технически сложных и уникальных объектов', subItems: [ { id: 'nok4_1', name: 'Билет для сдачи, 2-е задачи или портфолио + ответ на 2 вопроса', costPrice: 15000, lowerPrice: 45000, upperPrice: 60000, minMargin: 30000, fee: 'госпошлина 22000', quantity: 1 }, { id: 'nok4_2', name: 'Гарантия, сдача в городе', costPrice: 29000, lowerPrice: 65000, upperPrice: 80000, minMargin: 36000, fee: 'госпошлина 22000', quantity: 1, city: 'Москва', cities: { 'Москва': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 }, 'Санкт-Петербург': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 }, 'Уфа': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 }, 'Казань': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 } } } ]}, { id: 'nok5', name: 'НОК по МЧС', subItems: [ { id: 'nok5_1', name: 'Гарантия, сдача', costPrice: 35000, lowerPrice: 70000, upperPrice: 85000, minMargin: 35000, fee: 'госпошлина 23000', quantity: 1, city: 'Москва', cities: { 'Москва': { cost: 35000, lower: 70000, upper: 85000, margin: 35000 }, 'Санкт-Петербург': { cost: 35000, lower: 70000, upper: 85000, margin: 35000 }, 'Уфа': { cost: 35000, lower: 70000, upper: 85000, margin: 35000 } } } ]}, { id: 'nok6', name: 'Помощь с оформлением трудовой книжки согласно требованиям НОСТРОЙ / НОПРИЗ', note: '5 рабочих дней', costPrice: 2500, lowerPrice: 20000, upperPrice: 30000, minMargin: 17500, fee: '', quantity: 1 }, { id: 'nok7', name: 'Подготовка документов для внесения в НРС, если у специалиста нет образования', note: '2-3 рабочих недели', costPrice: 21000, lowerPrice: 65000, upperPrice: 90000, minMargin: 44000, fee: '', quantity: 1 } ] },
          { category: 'Обучения', icon: icons.edu, color: 'edu', items: [ { id: 'edu1', name: 'Охрана Труда', note: 'Уточнить программу обучения', costPrice: 500, lowerPrice: 2500, upperPrice: 4000, minMargin: 2000, fee: '', quantity: 1 }, { id: 'edu2', name: 'Удостоверение повышения квалификации', note: 'Уточнить специальности', costPrice: 500, lowerPrice: 5000, upperPrice: 7000, minMargin: 4500, fee: '', quantity: 1, type: 'Обычное', types: { 'Обычное': { note: 'срок 1 рабочий день', lower: 5000, upper: 7000, cost: 500 }, 'Задним числом': { note: 'срок 1 рабочий день (задним числом)', lower: 15500, upper: 18500, cost: 2500 } } }, { id: 'edu3', name: 'Профессиональная переподготовка по пожарнотехническому минимуму (ПТМ)', note: 'Обучение ответственного сотрудника, срок 1 рабочий день', costPrice: 5500, lowerPrice: 15500, upperPrice: 20500, minMargin: 10000, fee: '', quantity: 1 }, { id: 'edu4', name: 'Промышленная Безопасность РТН Челябинск (любая область знаний кроме В.4)', note: 'Реальное присутствие на экзамене, срок 2-4 недели', costPrice: 25000, lowerPrice: 50000, upperPrice: 65000, minMargin: 25000, fee: '', quantity: 1 }, { id: 'edu5', name: 'Промышленная Безопасность через комиссию ЕПТ (единый портал тестирования)', note: 'Дистанционная форма, срок 3 рабочих дня', costPrice: 6000, lowerPrice: 20000, upperPrice: 25000, minMargin: 14000, fee: '', quantity: 1 }, { id: 'edu6', name: 'Рабочие профессии по специальностям', note: 'Любые профессии, срок 1 раб. день', costPrice: 1500, lowerPrice: 6500, upperPrice: 8500, minMargin: 5000, fee: '', quantity: 1 }, { id: 'edu7', name: 'Профессиональная переподготовка (программы по запросу)', note: 'Запросить программу, обучаем только с высшим образованием, срок 3 раб дня', costPrice: 5500, lowerPrice: 15500, upperPrice: 20500, minMargin: 10000, fee: '', quantity: 1 }, { id: 'edu8', name: 'Электробезопасность 2 - 5 группа', costPrice: 25000, lowerPrice: 50000, upperPrice: 65000, minMargin: 25000, fee: '', quantity: 1, type: 'Присутствие', types: { 'Присутствие': { note: 'Присутствие в Челябинске (любая группа), срок 4 недели', cost: 25000, lower: 50000, upper: 65000, margin: 25000 }, 'Дистанционно': { note: 'Дистанционно (стоимость за одну группу), срок 4-5 недели', cost: 40000, lower: 80000, upper: 95000, margin: 40000 } } } ] },
          { category: 'Лицензирование', icon: icons.lic, color: 'lic', items: [ { id: 'lic1', name: 'Лицензия МЧС', note: 'Запросить у клиента регион и виды лицензируемой деятельности (их 9), 45 рабочих дней', costPrice: 10000, lowerPrice: 0, upperPrice: 0, minMargin: 0, fee: '', quantity: 1, customPrice: true }, { id: 'lic2', name: 'МинКультуры', note: 'Запросить у клиента номера и количество лицензируемых направлений (11 направлений, от двух в запросе), 45 рабочих дней', costPrice: 200000, lowerPrice: 0, upperPrice: 0, minMargin: 0, fee: '', quantity: 1, customPrice: true }, { id: 'lic3', name: 'Электролаборатория', note: 'Запросить класс напряжения для лицензирования, срок до 35 рабочих дней', costPrice: 55000, lowerPrice: 0, upperPrice: 0, minMargin: 0, fee: '', quantity: 1, customPrice: true } ] },
          { category: 'ISO', icon: icons.iso, color: 'iso', items: [ { id: 'iso1', name: 'ISO 9001, 14001, 18001, 22000, 51705.1', note: 'Цена за каждый из перечисленных, срок 2 дня', costPrice: 1500, lowerPrice: 15000, upperPrice: 25000, minMargin: 13500, fee: '', quantity: 1 }, { id: 'iso2', name: 'Интегрированная система ISO (3 сертификата из списка)', note: 'Цена за три сертификата, срок 2-3 дня', costPrice: 4500, lowerPrice: 30000, upperPrice: 50000, minMargin: 25500, fee: '', quantity: 1 } ] },
          { category: 'ВИК', icon: icons.vik, color: 'vik', items: [ { id: 'vik1', name: 'Аттестация ЛНК ( ВИК, РК, ЛК, УК, МК)', note: 'Заполнить заявку, срок 45 дней', costPrice: 17000, lowerPrice: 0, upperPrice: 0, minMargin: 0, fee: '', quantity: 1, customPrice: true } ] },
          { category: 'СОУТ', icon: icons.sout, color: 'sout', items: [ { id: 'sout1', name: 'Подготовка пакета документов на аттестацию рабочих мест всех заявленных специалистов', note: 'Разработка штатного расписания, срок 2-3 дня', costPrice: 1000, lowerPrice: 5000, upperPrice: 6000, minMargin: 4000, fee: '', quantity: 1 }, { id: 'sout2', name: 'СОУТ 1-5 рабочих мест', note: 'Просчет по штатному расписанию за пакет, срок 3 недели', costPrice: 3000, lowerPrice: 0, upperPrice: 0, minMargin: 0, fee: '', quantity: 1, customPrice: true }, { id: 'sout3', name: 'СОУТ от 6 до 10 рабочих мест', note: 'Просчет по штатному расписанию за пакет, срок 3 недели', costPrice: 10000, lowerPrice: 0, upperPrice: 0, minMargin: 0, fee: '', quantity: 1, customPrice: true }, { id: 'sout4', name: 'СОУТ от 11 и выше', note: 'Просчет по штатному расписанию за одно РМ, срок 3 недели', costPrice: 700, lowerPrice: 0, upperPrice: 0, minMargin: 0, fee: '', quantity: 1, customPrice: true } ] }
        ];

        setServices(servicesData);
        setActiveCategory(servicesData[0].category);
      }, []);

      // Пересчет итогов при изменении корзины
      React.useEffect(() => {
        let priceTotal = 0;
        let costTotal = 0;

        selectedServices.forEach(service => {
          let pricePerUnit;
          if (service.customPrice) {
            // Для услуг с индивидуальной ценой, она хранится в объекте customPrice
            pricePerUnit = service.customPrice.current || 0;
          } else {
            // Для стандартных услуг используется цена, настроенная ползунком
            pricePerUnit = service.manualPrice || 0;
          }
          priceTotal += pricePerUnit * service.quantity;
          costTotal += service.costPrice * service.quantity;
        });

        setTotalPrice(priceTotal);
        setTotalCostPrice(costTotal);
        setTotalMargin(priceTotal - costTotal);
      }, [selectedServices]);

      const showNotification = (message) => {
        setNotification(message);
        setTimeout(() => setNotification(''), 3000);
      };

      const handleAddService = (item, subItem = null) => {
        const serviceToAdd = subItem ? { ...subItem, parentName: item.name, color: item.color, category: item.category } : { ...item };
        
        // Устанавливаем начальную цену для ползунка или объекта кастомной цены
        if (!serviceToAdd.customPrice) {
          serviceToAdd.manualPrice = (serviceToAdd.lowerPrice + serviceToAdd.upperPrice) / 2;
        } else if (serviceToAdd.customPrice === true) {
          // Преобразуем флаг в объект для хранения кастомной цены
          serviceToAdd.customPrice = { current: serviceToAdd.costPrice, min: serviceToAdd.costPrice, max: serviceToAdd.costPrice + 100000 };
        }
        
        const existingServiceIndex = selectedServices.findIndex(s => s.id === serviceToAdd.id);

        if (existingServiceIndex !== -1) {
          const updatedServices = [...selectedServices];
          updatedServices[existingServiceIndex].quantity += 1;
          setSelectedServices(updatedServices);
          showNotification('Количество услуги увеличено!');
        } else {
          setSelectedServices([...selectedServices, serviceToAdd]);
          showNotification('Услуга добавлена в корзину!');
        }
      };

      const handleRemoveService = (id) => {
        setSelectedServices(selectedServices.filter(service => service.id !== id));
        showNotification('Услуга удалена из корзины');
      };
      
      const handleClearCart = () => {
        if (selectedServices.length > 0) {
            setSelectedServices([]);
            showNotification('Корзина очищена');
        }
      };

      const handleQuantityChange = (id, newQuantity) => {
        if (newQuantity < 1) return;
        setSelectedServices(selectedServices.map(s => s.id === id ? { ...s, quantity: newQuantity } : s));
      };
      
      const updateServiceInCart = (id, updates) => {
        setSelectedServices(selectedServices.map(service => {
          if (service.id === id) {
            const updatedService = { ...service, ...updates };
            // Если меняются границы цены, сбрасываем ручную цену на середину
            if (updates.lowerPrice !== undefined && updates.upperPrice !== undefined) {
              updatedService.manualPrice = (updates.lowerPrice + updates.upperPrice) / 2;
            }
            return updatedService;
          }
          return service;
        }));
      };

      const handleRegionChange = (id, newRegion) => {
        const service = selectedServices.find(s => s.id === id);
        if (service && service.priceByRegion && service.priceByRegion[newRegion]) {
          const regionData = service.priceByRegion[newRegion];
          // Проверяем наличие noteByRegion перед использованием
          const newNote = service.noteByRegion ? service.noteByRegion[newRegion] : service.note;
          updateServiceInCart(id, { region: newRegion, lowerPrice: regionData.lower, upperPrice: regionData.upper, costPrice: regionData.cost, note: newNote });
        }
      };

      const handleCityChange = (id, newCity) => {
        const service = selectedServices.find(s => s.id === id);
        if (service && service.cities && service.cities[newCity]) {
          const cityData = service.cities[newCity];
          updateServiceInCart(id, { city: newCity, costPrice: cityData.cost, lowerPrice: cityData.lower, upperPrice: cityData.upper, minMargin: cityData.margin });
        }
      };

      const handleTypeChange = (id, newType) => {
        const service = selectedServices.find(s => s.id === id);
        if (service && service.types && service.types[newType]) {
          const typeData = service.types[newType];
          updateServiceInCart(id, { type: newType, costPrice: typeData.cost || service.costPrice, lowerPrice: typeData.lower, upperPrice: typeData.upper, note: typeData.note || service.note });
        }
      };

      const handleCustomPriceChange = (id, price) => {
        const service = selectedServices.find(s => s.id === id);
        if (service && typeof service.customPrice === 'object') {
          const newCustomPrice = { ...service.customPrice, current: Number(price) || 0 };
          updateServiceInCart(id, { customPrice: newCustomPrice });
        }
      };
      
      const handleManualPriceChange = (id, price) => {
        const service = selectedServices.find(s => s.id === id);
        if (!service) return;
        // Убедимся, что цена не выходит за установленные рамки
        const validatedPrice = Math.min(Math.max(price, service.lowerPrice), service.upperPrice);
        updateServiceInCart(id, { manualPrice: validatedPrice });
      };

      const formatPrice = (price) => new Intl.NumberFormat('ru-RU').format(price);
      
      const copyToClipboard = () => {
        // Копируем текст из состояния, чтобы избежать копирования стилей (фона)
        if (proposalText) {
          // Использовать document.execCommand('copy') напрямую, так как navigator.clipboard может быть заблокирован в iframe
          const textArea = document.createElement("textarea");
          textArea.value = proposalText;
          textArea.style.position = "fixed";
          textArea.style.top = "-9999px";
          textArea.style.left = "-9999px";
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          try {
            document.execCommand('copy');
            showNotification('Предложение скопировано!');
          } catch (e) {
            console.error('Ошибка копирования: ', e);
            showNotification('Не удалось скопировать.');
          }
          document.body.removeChild(textArea);
        }
      };
      
      const generateProposal = () => {
        if (selectedServices.length === 0) {
          showNotification('Необходимо выбрать хотя бы одну услугу!');
          return;
        }
        
        let proposal = '================================\n';
        proposal += 'КОММЕРЧЕСКОЕ ПРЕДЛОЖЕНИЕ\n';
        proposal += '================================\n\n';
        proposal += 'Уважаемый(ая) [Имя клиента],\n\n';
        proposal += 'Благодарим за ваш интерес к нашим услугам. Представляем вам расчет стоимости по вашему запросу:\n\n';
        proposal += '--------------------------------\n';
        proposal += 'ДЕТАЛИЗАЦИЯ УСЛУГ\n';
        proposal += '--------------------------------\n\n';
        
        // Сбор информации о сроках выполнения работ
        let deliveryTerms = [];
        selectedServices.forEach((service, index) => {
          const serviceName = service.parentName ? `${service.parentName} - ${service.name}` : service.name;
          // Корректно определяем цену
          let price = service.customPrice ? service.customPrice.current : service.manualPrice;
          const formattedPrice = typeof price === 'number' ? formatPrice(price) + ' ₽' : 'Индивидуальный расчет';
          
          proposal += `${index + 1}. ${serviceName}\n`;
          proposal += `   - Стоимость: ${formattedPrice}\n`;
          proposal += `   - Количество: ${service.quantity} шт.\n`;
          if (service.note) {
            proposal += `   - Срок и детали: ${service.note}\n`;
            deliveryTerms.push(`${serviceName}: ${service.note}`);
          }
          if (service.region) proposal += `   - Регион: ${service.region}\n`;
          if (service.city) proposal += `   - - Город: ${service.city}\n`;
          if (service.fee) proposal += `   - Дополнительно: ${service.fee}\n`;
          proposal += '\n';
        });
        
        proposal += '--------------------------------\n';
        proposal += 'ИТОГОВЫЙ РАСЧЕТ\n';
        proposal += '--------------------------------\n\n';
        proposal += `Общая стоимость: ${formatPrice(totalPrice)} ₽\n`;
        proposal += '(Включая все налоги и сборы)\n\n';

        proposal += '================================\n';
        proposal += 'УСЛОВИЯ ПРЕДЛОЖЕНИЯ\n';
        proposal += '================================\n\n';
        proposal += '- Данное предложение действительно в течение 14 календарных дней.\n';
        proposal += '- Для начала работ требуется 100% предоплата.\n';
        proposal += '- По всем вопросам, пожалуйста, обращайтесь к вашему менеджеру.\n\n';
        
        // Добавление информации о сроках выполнения работ
        if (deliveryTerms.length > 0) {
            proposal += 'Сроки выполнения работ:\n';
            deliveryTerms.forEach(term => {
                proposal += `- ${term}\n`;
            });
            proposal += '\n';
        }

        proposal += 'С уважением,\n';
        proposal += 'Команда "Бизнес Решение"\n';
        proposal += '+7 (XXX) XXX-XX-XX';
        
        setProposalText(proposal);
        setShowProposal(true);
      };

      const filteredServices = services.map(category => ({
        ...category,
        items: category.items.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase()) || (item.subItems && item.subItems.some(sub => sub.name.toLowerCase().includes(searchTerm.toLowerCase()))))
      })).filter(category => category.items.length > 0);

      const marginPercentage = totalPrice > 0 ? ((totalMargin / totalPrice) * 100).toFixed(1) : 0;

      const groupedSelectedServices = selectedServices.reduce((acc, service) => {
        const category = service.category || 'Прочее';
        if (!acc[category]) {
            acc[category] = {
                color: service.color,
                items: []
            };
        }
        acc[category].items.push(service);
        return acc;
      }, {});

      return (
        <div className="min-h-screen">
          {notification && (
            <div className="notification px-6 py-3 text-sm font-semibold">
              {notification}
            </div>
          )}

          <header className="header-aurora bg-gray-900/50 backdrop-blur-lg border-b border-gray-700/50 text-white shadow-lg sticky top-0 z-50">
            <div className="container mx-auto py-6 px-6 text-center">
              <h1 className="text-4xl md:text-5xl font-extrabold tracking-tight animated-gradient-text">
                Orion Price
              </h1>
              <p className="text-md text-gray-400 mt-2">Ваш навигатор в мире бизнес-решений</p>
            </div>
          </header>
          
          {showProposal ? (
            <div className="container mx-auto p-4 md:p-6 mt-8">
              <div className="premium-card p-6 md:p-8 animate-fade-in">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-3xl font-bold text-white flex items-center space-x-3">
                    {icons.proposal}
                    <span>Коммерческое предложение</span>
                  </h2>
                  <div className="flex space-x-3">
                    <button className="bg-amber-500 hover:bg-amber-600 text-black px-5 py-2 rounded-lg font-bold flex items-center space-x-2 transition-all duration-300 transform hover:scale-105" onClick={copyToClipboard}>
                      {icons.copy}
                      <span>Копировать</span>
                    </button>
                    <button className="bg-gray-700 hover:bg-gray-600 text-white px-5 py-2 rounded-lg font-bold flex items-center space-x-2 transition-all duration-300" onClick={() => setShowProposal(false)}>
                      {icons.back}
                      <span>Назад</span>
                    </button>
                  </div>
                </div>
                {/* ref здесь нужен только для возможного скролла, а не для копирования */}
                <pre ref={proposalRef} className="p-6 border border-gray-700 rounded-lg bg-gray-900 text-gray-300 whitespace-pre-wrap font-mono text-sm leading-relaxed shadow-inner">
                  {proposalText}
                </pre>
              </div>
            </div>
          ) : (
            <div className="container mx-auto p-4 md:p-6 flex flex-col lg:flex-row gap-8 mt-8" id="main-content">
              {/* Основная область */}
              <div className="flex-grow">
                <div ref={servicesListRef} className="premium-card p-6 md:p-8 animate-fade-in">
                  {/* Поиск и категории */}
                  <div className="mb-8">
                    <div className="relative mb-6">
                      <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        {icons.search}
                      </div>
                      <input
                        type="text"
                        placeholder="Найти услугу..."
                        className="w-full pl-12 pr-4 py-3 bg-gray-900 border border-gray-700 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-500/50 transition-all text-base"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                      />
                    </div>
                    
                    <div className="flex flex-wrap gap-3">
                      {services.map(category => (
                        <button
                          key={category.category}
                          className={`px-4 py-2 rounded-lg font-semibold text-sm flex items-center space-x-2 transition-all duration-300 ${
                            activeCategory === category.category
                              ? `accent-cat-${category.color} text-black shadow-md scale-105`
                              : 'bg-gray-800 text-gray-300 hover:bg-gray-700 hover:text-white'
                          }`}
                          onClick={() => {
                            setActiveCategory(category.category);
                            servicesListRef.current.scrollIntoView({ behavior: 'smooth' });
                          }}
                        >
                          {category.icon}
                          <span>{category.category}</span>
                        </button>
                      ))}
                    </div>
                  </div>
                  
                  {/* Услуги */}
                  <div className="space-y-4">
                    {filteredServices.map(category => (
                      <div key={category.category} className={`${activeCategory === category.category ? 'block' : 'hidden'}`}>
                        {category.items.map(item => (
                          <div key={item.id} className={`service-card p-4 mb-4 border-cat-${category.color} animate-fade-in`}>
                            <h3 className="font-bold text-lg text-white mb-2">{item.name}</h3>
                            {item.note && <p className="text-gray-400 text-sm mb-3">{item.note}</p>}
                            
                            {item.subItems ? (
                              <div className="space-y-3 pt-2">
                                {item.subItems.map(subItem => (
                                  <div key={subItem.id} className="flex justify-between items-center bg-gray-800/50 p-3 rounded-md">
                                    <div>
                                      <p className="font-semibold text-gray-200">{subItem.name}</p>
                                      {subItem.note && <p className="text-gray-400 text-xs mt-1">{subItem.note}</p>}
                                    </div>
                                    <div className="flex items-center flex-shrink-0 ml-4">
                                      <p className={`text-base font-bold text-cat-${category.color} mr-4`}>
                                        {formatPrice(subItem.lowerPrice)} - {formatPrice(subItem.upperPrice)} ₽
                                      </p>
                                      <button
                                        className={`accent-cat-${category.color} text-black px-4 py-2 rounded-lg font-bold text-sm flex items-center space-x-2 ml-auto transition-transform hover:scale-105`}
                                        onClick={() => handleAddService(item, subItem)}
                                      >
                                        <span>+</span>
                                        <span>Добавить</span>
                                      </button>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <div className="flex justify-between items-center pt-2">
                                <p className={`text-xl font-bold text-cat-${category.color}`}>
                                  {item.customPrice === true 
                                    ? "Индивидуально"
                                    : `${formatPrice(item.lowerPrice)} - ${formatPrice(item.upperPrice)} ₽`}
                                </p>
                                <button
                                  className={`accent-cat-${category.color} text-black px-4 py-2 rounded-lg font-bold text-sm flex items-center space-x-2 transition-transform hover:scale-105`}
                                  onClick={() => handleAddService(item)}
                                >
                                  <span>+</span>
                                  <span>Добавить</span>
                                </button>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
              
              {/* Корзина */}
              <div className="w-full lg:w-[450px] lg:flex-shrink-0">
                <div className="premium-card p-6 sticky top-28 animate-fade-in">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-bold text-white flex items-center space-x-3">
                      {icons.cart}
                      <span>Ваш расчет</span>
                      {selectedServices.length > 0 && (
                        <span className="bg-amber-500 text-black rounded-full w-7 h-7 flex items-center justify-center text-sm font-bold">
                          {selectedServices.length}
                        </span>
                      )}
                    </h2>
                    {selectedServices.length > 0 && (
                        <button onClick={handleClearCart} title="Очистить корзину" className="text-gray-500 hover:text-red-500 transition-colors p-1">
                            {icons.clear}
                        </button>
                    )}
                  </div>
                  
                  {selectedServices.length === 0 ? (
                    <div className="text-center py-16">
                      {icons.emptyCart}
                      <p className="text-gray-400 font-medium mt-4">Корзина пуста</p>
                      <p className="text-gray-500 text-sm">Добавьте услуги для начала расчета</p>
                    </div>
                  ) : (
                    <div className="space-y-6 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                      {Object.entries(groupedSelectedServices).map(([categoryName, group]) => (
                        <div key={categoryName}>
                            <h3 className={`text-lg font-bold mb-2 pb-1 border-b-2 border-cat-${group.color} text-cat-${group.color}`}>
                                {categoryName}
                            </h3>
                            <div className="space-y-4">
                                {group.items.map(service => (
                                    <div key={service.id} className="p-4 rounded-lg bg-gray-800/50">
                                        <div className="flex justify-between items-start mb-3">
                                            <h4 className="font-semibold text-gray-200 leading-tight text-sm pr-2">
                                            {service.parentName ? `${service.parentName} - ${service.name}` : service.name}
                                            </h4>
                                            <button className="text-gray-500 hover:text-red-500 transition-colors flex-shrink-0" onClick={() => handleRemoveService(service.id)}>
                                            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd"></path></svg>
                                            </button>
                                        </div>
                                        
                                        <div className="space-y-3">
                                            {service.regions && (<select className="w-full text-sm p-2 rounded-md custom-select" value={service.region} onChange={(e) => handleRegionChange(service.id, e.target.value)}>{service.regions.map(r => (<option key={r} value={r}>{r}</option>))}</select>)}
                                            {service.cities && (<select className="w-full text-sm p-2 rounded-md custom-select" value={service.city} onChange={(e) => handleCityChange(service.id, e.target.value)}>{Object.keys(service.cities).map(c => (<option key={c} value={c}>{c}</option>))}</select>)}
                                            {service.types && (<select className="w-full text-sm p-2 rounded-md custom-select" value={service.type} onChange={(e) => handleTypeChange(service.id, e.target.value)}>{Object.keys(service.types).map(t => (<option key={t} value={t}>{t}</option>))}</select>)}

                                            <div className="flex items-center">
                                            <label className="text-sm font-medium text-gray-400 mr-3">Кол-во:</label>
                                            <div className="flex items-center">
                                                <button className="bg-gray-700 hover:bg-gray-600 w-7 h-7 rounded-l-md font-bold transition-colors" onClick={() => handleQuantityChange(service.id, service.quantity - 1)}>−</button>
                                                <input type="number" className="w-12 text-center bg-gray-900 border-y border-gray-700 h-7 font-bold" value={service.quantity} onChange={(e) => handleQuantityChange(service.id, parseInt(e.target.value) || 1)} min="1" />
                                                <button className="bg-gray-700 hover:bg-gray-600 w-7 h-7 rounded-r-md font-bold transition-colors" onClick={() => handleQuantityChange(service.id, service.quantity + 1)}>+</button>
                                            </div>
                                            </div>
                                            
                                            <div>
                                                <div className="flex items-center justify-between mb-1">
                                                    <label className="text-sm font-medium text-gray-400">Цена:</label>
                                                    <span className="text-sm font-bold text-amber-400">{service.customPrice ? 'Индивидуально' : `${formatPrice(service.lowerPrice)} - ${formatPrice(service.upperPrice)} ₽`}</span>
                                                </div>
                                                {service.customPrice ? (
                                                    <input type="range" className="w-full custom-range" min={service.customPrice.min} max={service.customPrice.max} step={1000} value={service.customPrice.current} onChange={(e) => handleCustomPriceChange(service.id, e.target.value)} />
                                                ) : (
                                                    <input type="range" className="w-full custom-range" min={service.lowerPrice} max={service.upperPrice} step={500} value={service.manualPrice} onChange={(e) => handleManualPriceChange(service.id, parseInt(e.target.value))} />
                                                )}
                                                <div className="flex items-center mt-2">
                                                    <input type="number" className="w-full text-sm p-2 bg-gray-900 border border-gray-700 rounded-md font-bold focus:border-amber-500 focus:ring-1 focus:ring-amber-500/50" value={service.customPrice ? (service.customPrice.current || 0) : (service.manualPrice || 0)} onChange={(e) => service.customPrice ? handleCustomPriceChange(service.id, e.target.value) : handleManualPriceChange(service.id, parseInt(e.target.value) || 0)} />
                                                    <span className="ml-2 font-bold text-gray-400">₽</span>
                                                </div>
                                            </div>

                                            {service.fee && (<div className="bg-amber-900/50 p-2 rounded-md text-xs text-amber-300 font-semibold">Доп: {service.fee}</div>)}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                      ))}
                    </div>
                  )}

                  {selectedServices.length > 0 && (
                    <div className="border-t-2 border-gray-700 pt-4 mt-4">
                      <div className="space-y-3 text-sm">
                        <div className="flex justify-between items-center p-2">
                          <span className="text-gray-400">Общая стоимость:</span>
                          <span className="font-bold text-lg text-white">{formatPrice(totalPrice)} ₽</span>
                        </div>
                        <div className="flex justify-between items-center cost-highlight">
                          <span className="text-gray-400">Себестоимость:</span>
                          <span className="font-bold text-gray-300">{formatPrice(totalCostPrice)} ₽</span>
                        </div>
                      </div>
                      <div className="mt-4 pt-4 border-t border-gray-700 space-y-3">
                        <div className="flex justify-between items-center p-2">
                          <span className="text-gray-300 font-semibold">Валовая прибыль (Маржа):</span>
                          <span className="font-bold text-lg text-green-400">{formatPrice(totalMargin)} ₽</span>
                        </div>
                        <div className="flex justify-between items-center p-2">
                          <span className="text-gray-300 font-semibold">Маржинальность:</span>
                          <span className={`font-bold text-lg ${marginPercentage >= 50 ? 'text-green-400' : marginPercentage >= 25 ? 'text-amber-400' : 'text-red-400'}`}>{marginPercentage}%</span>
                        </div>
                      </div>
                      <button
                        className="w-full bg-amber-500 hover:bg-amber-600 text-black py-3 mt-6 rounded-lg font-extrabold text-base transition-all duration-300 transform hover:scale-105 shadow-lg shadow-amber-500/20"
                        onClick={generateProposal}
                      >
                        Сформировать предложение
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}
          
          <footer className="bg-transparent text-white py-8 mt-16">
            <div className="container mx-auto px-6 text-center text-gray-600 text-sm">
              <p>© 2025 Orion Price</p>
              <p>Разработано для "Бизнес Решение"</p>
            </div>
          </footer>
        </div>
      );
    };

    // Рендерим приложение
    ReactDOM.render(<ServiceCalculator />, document.getElementById('root'));
  </script>
</body>
</html>
