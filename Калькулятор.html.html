<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Калькулятор услуг</title>
  
  <!-- Загрузка необходимых библиотек -->
  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Tailwind CSS для стилей -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /* Дополнительные стили если нужны */
    .custom-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
    }
    .custom-range::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    // Основной компонент приложения
    const ServiceCalculator = () => {
      const [services, setServices] = React.useState([]);
      const [selectedServices, setSelectedServices] = React.useState([]);
      const [totalPrice, setTotalPrice] = React.useState(0);
      const [activeCategory, setActiveCategory] = React.useState(null);
      const [searchTerm, setSearchTerm] = React.useState('');
      const [isPriceListVisible, setIsPriceListVisible] = React.useState(false);
      const [showProposal, setShowProposal] = React.useState(false);
      const [proposalText, setProposalText] = React.useState('');
      const proposalRef = React.useRef(null);

      React.useEffect(() => {
        // Initialize services from the price list
        const servicesData = [
          {
            category: 'СРО',
            items: [
              {
                id: 'sro1',
                name: 'Подготовка документов для допуска СРО (по юридическому адресу)',
                note: 'Обычные регионы, срок от 1 недели',
                costPrice: 0,
                lowerPrice: 20000,
                upperPrice: 35000,
                minMargin: 20000,
                fee: '',
                quantity: 1,
                region: 'Обычные регионы',
                regions: ['Обычные регионы', 'Сложные регионы (Оренбург, Тюмень и др.)'],
                priceByRegion: {
                  'Обычные регионы': { lower: 20000, upper: 35000 },
                  'Сложные регионы (Оренбург, Тюмень и др.)': { lower: 35000, upper: 40000 }
                },
                noteByRegion: {
                  'Обычные регионы': 'Обычные регионы, срок от 1 недели',
                  'Сложные регионы (Оренбург, Тюмень и др.)': 'Сложные регионы, срок от 1 недели'
                },
                regionNotes: {
                  'Обычные регионы': '',
                  'Сложные регионы (Оренбург, Тюмень и др.)': 'Оренбург, Тюмень, Кемерово, Челябинск, Калининград, Астрахань'
                }
              }
            ]
          },
          {
            category: 'НРС',
            items: [
              {
                id: 'nrs1',
                name: 'Подбор и предоставление специалиста, включенного в НРС НОСТРОЙ / НОПРИЗ с оригиналом ТК и ЭТК',
                note: 'Срок реализации 3-7 рабочих дней',
                costPrice: 0,
                lowerPrice: 40000,
                upperPrice: 50000,
                minMargin: 45000,
                fee: 'МРОТ',
                quantity: 1,
                region: 'Обычные регионы',
                regions: ['Обычные регионы', 'Сложные регионы (Оренбург, Тюмень и др.)'],
                priceByRegion: {
                  'Обычные регионы': { lower: 40000, upper: 50000 },
                  'Сложные регионы (Оренбург, Тюмень и др.)': { lower: 60000, upper: 75000 }
                },
                regionNotes: {
                  'Обычные регионы': '',
                  'Сложные регионы (Оренбург, Тюмень и др.)': 'Оренбург, Тюмень, Кемерово, Челябинск, Калининград, Астрахань'
                }
              },
              {
                id: 'nrs2',
                name: 'Подбор специалиста в НРС НОСТРОЙ только УрСиб, без выплаты ему ЗП',
                note: 'на 12 месяцев одного специалиста (либо до ближайшей проверки СРО с уменьшением стоимости услуги)',
                costPrice: 35000,
                lowerPrice: 180000,
                upperPrice: 195000,
                minMargin: 145000,
                fee: '',
                quantity: 1
              },
              {
                id: 'nrs3',
                name: 'Подбор специалиста в НРС НОСТРОЙ, без выплаты ему ЗП',
                note: 'на 12 месяцев одного специалиста (либо до ближайшей проверки СРО с уменьшением стоимости услуги)',
                costPrice: 0,
                lowerPrice: 80000,
                upperPrice: 120000,
                minMargin: 80000,
                fee: '',
                quantity: 1
              },
              {
                id: 'nrs4',
                name: 'Подбор и предоставление специалиста для ОПО',
                note: 'на 12 месяцев одного специалиста (либо до ближайшей проверки СРО с уменьшением стоимости услуги)',
                costPrice: 0,
                lowerPrice: 35000,
                upperPrice: 50000,
                minMargin: 30000,
                fee: 'МРОТ',
                quantity: 1
              },
              {
                id: 'nrs5',
                name: 'Подготовка документов для внесения в НРС',
                note: 'Запросить справку о несудимости, стаж и диплом, НОК, срок 5 рабочих дней',
                costPrice: 0,
                lowerPrice: 15000,
                upperPrice: 25000,
                minMargin: 15000,
                fee: '',
                quantity: 1
              }
            ]
          },
          {
            category: 'НОК',
            items: [
              {
                id: 'nok1',
                name: 'НОК (Независимая оценка квалификаций) НОСТРОЙ',
                subItems: [
                  {
                    id: 'nok1_1',
                    name: 'Сдача экзамена по билету (база) по месту пребывания',
                    costPrice: 9000,
                    lowerPrice: 35000,
                    upperPrice: 50000,
                    minMargin: 26000,
                    fee: 'госпошлина 24000',
                    quantity: 1
                  },
                  {
                    id: 'nok1_2',
                    name: 'Сдача экзамена по закрепленному билету',
                    costPrice: 15000,
                    lowerPrice: 40000,
                    upperPrice: 55000,
                    minMargin: 35000,
                    fee: 'госпошлина 24000',
                    quantity: 1
                  },
                  {
                    id: 'nok1_3',
                    name: 'Гарантия сдачи с прибытием в город',
                    costPrice: 25000,
                    lowerPrice: 65000,
                    upperPrice: 80000,
                    minMargin: 40000,
                    fee: 'госпошлина 24000',
                    quantity: 1,
                    city: 'Ростов-на-Дону',
                    cities: {
                      'Ростов-на-Дону': { cost: 25000, lower: 65000, upper: 80000, margin: 40000 },
                      'Краснодар': { cost: 25000, lower: 65000, upper: 80000, margin: 40000 },
                      'Калининград': { cost: 25000, lower: 65000, upper: 80000, margin: 40000 },
                      'Сыктывкар': { cost: 25000, lower: 65000, upper: 80000, margin: 40000 },
                      'Москва': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 },
                      'Санкт-Петербург': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 },
                      'Красногорск': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 },
                      'Реутов': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 },
                      'Уфа': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 },
                      'Казань': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 },
                      'Сочи': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 },
                      'Хабаровск': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 },
                      'Челябинск': { cost: 25000, lower: 65000, upper: 70000, margin: 40000 },
                      'Екатеринбург': { cost: 25000, lower: 65000, upper: 70000, margin: 40000 },
                      'Адлер': { cost: 25000, lower: 65000, upper: 70000, margin: 40000 },
                      'Лениногорск': { cost: 25000, lower: 65000, upper: 70000, margin: 40000 },
                      'Нижний Новгород': { cost: 25000, lower: 65000, upper: 70000, margin: 40000 },
                      'Курган': { cost: 35000, lower: 75000, upper: 90000, margin: 40000 }
                    }
                  }
                ]
              },
              {
                id: 'nok2',
                name: 'НОК (Независимая оценка квалификации) НОПРИЗ',
                subItems: [
                  {
                    id: 'nok2_1',
                    name: 'Билет для сдачи без подготовки портфолио, портфолио ваш',
                    costPrice: 9000,
                    lowerPrice: 40000,
                    upperPrice: 55000,
                    minMargin: 30000,
                    fee: 'госпошлина 22000',
                    quantity: 1
                  },
                  {
                    id: 'nok2_2',
                    name: 'Сдача экзамена по закрепленному билету',
                    costPrice: 15000,
                    lowerPrice: 40000,
                    upperPrice: 55000,
                    minMargin: 35000,
                    fee: 'госпошлина 22000',
                    quantity: 1
                  },
                  {
                    id: 'nok2_3',
                    name: 'Гарантия сдачи с прибытием в город',
                    costPrice: 29000,
                    lowerPrice: 65000,
                    upperPrice: 80000,
                    minMargin: 36000,
                    fee: 'госпошлина 22000',
                    quantity: 1,
                    city: 'Москва',
                    cities: {
                      'Москва': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 },
                      'Санкт-Петербург': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 },
                      'Красногорск': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 },
                      'Уфа': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 },
                      'Казань': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 },
                      'Адлер': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 }
                    }
                  }
                ]
              },
              {
                id: 'nok3',
                name: 'НОК для специалиста по строительству особо опасных, технически сложных и уникальных объектов',
                subItems: [
                  {
                    id: 'nok3_1',
                    name: 'Гарантия, сдача в городе',
                    costPrice: 29000,
                    lowerPrice: 65000,
                    upperPrice: 80000,
                    minMargin: 36000,
                    fee: 'госпошлина 24000',
                    quantity: 1,
                    city: 'Москва',
                    cities: {
                      'Москва': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 },
                      'Санкт-Петербург': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 },
                      'Уфа': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 },
                      'Казань': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 }
                    }
                  }
                ]
              },
              {
                id: 'nok4',
                name: 'НОК для специалиста по проектированию особо опасных, технически сложных и уникальных объектов',
                subItems: [
                  {
                    id: 'nok4_1',
                    name: 'Билет для сдачи, 2-е задачи или портфолио + ответ на 2 вопроса',
                    costPrice: 15000,
                    lowerPrice: 45000,
                    upperPrice: 60000,
                    minMargin: 30000,
                    fee: 'госпошлина 22000',
                    quantity: 1
                  },
                  {
                    id: 'nok4_2',
                    name: 'Гарантия, сдача в городе',
                    costPrice: 29000,
                    lowerPrice: 65000,
                    upperPrice: 80000,
                    minMargin: 36000,
                    fee: 'госпошлина 22000',
                    quantity: 1,
                    city: 'Москва',
                    cities: {
                      'Москва': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 },
                      'Санкт-Петербург': { cost: 29000, lower: 65000, upper: 80000, margin: 36000 },
                      'Уфа': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 },
                      'Казань': { cost: 34000, lower: 70000, upper: 85000, margin: 36000 }
                    }
                  }
                ]
              },
              {
                id: 'nok5',
                name: 'НОК по МЧС',
                subItems: [
                  {
                    id: 'nok5_1',
                    name: 'Гарантия, сдача',
                    costPrice: 35000,
                    lowerPrice: 70000,
                    upperPrice: 85000,
                    minMargin: 35000,
                    fee: 'госпошлина 23000',
                    quantity: 1,
                    city: 'Москва',
                    cities: {
                      'Москва': { cost: 35000, lower: 70000, upper: 85000, margin: 35000 },
                      'Санкт-Петербург': { cost: 35000, lower: 70000, upper: 85000, margin: 35000 },
                      'Уфа': { cost: 35000, lower: 70000, upper: 85000, margin: 35000 }
                    }
                  }
                ]
              },
              {
                id: 'nok6',
                name: 'Помощь с оформлением трудовой книжки согласно требованиям НОСТРОЙ / НОПРИЗ',
                note: '5 рабочих дней',
                costPrice: 2500,
                lowerPrice: 20000,
                upperPrice: 30000,
                minMargin: 15500,
                fee: '',
                quantity: 1
              },
              {
                id: 'nok7',
                name: 'Подготовка документов для внесения в НРС, если у специалиста нет образования',
                note: '2-3 рабочих недели',
                costPrice: 21000,
                lowerPrice: 65000,
                upperPrice: 90000,
                minMargin: 44000,
                fee: '',
                quantity: 1
              }
            ]
          },
          {
            category: 'Обучения',
            items: [
              {
                id: 'edu1',
                name: 'Охрана Труда',
                note: 'Уточнить программу обучения',
                costPrice: 500,
                lowerPrice: 2500,
                upperPrice: 4000,
                minMargin: 1500,
                fee: '',
                quantity: 1
              },
              {
                id: 'edu2',
                name: 'Удостоверение повышения квалификации',
                note: 'Уточнить специальности',
                costPrice: 500,
                lowerPrice: 5000,
                upperPrice: 7000,
                minMargin: 4500,
                fee: '',
                quantity: 1,
                type: 'Обычное',
                types: {
                  'Обычное': { note: 'срок 1 рабочий день', lower: 5000, upper: 7000 },
                  'Задним числом': { note: 'срок 1 рабочий день (задним числом)', lower: 15500, upper: 18500 }
                }
              },
              {
                id: 'edu3',
                name: 'Профессиональная переподготовка по пожарнотехническому минимуму (ПТМ)',
                note: 'Обучение ответственного сотрудника, срок 1 рабочий день',
                costPrice: 5500,
                lowerPrice: 15500,
                upperPrice: 20500,
                minMargin: 14500,
                fee: '',
                quantity: 1
              },
              {
                id: 'edu4',
                name: 'Промышленная Безопасность РТН Челябинск (любая область знаний кроме В.4)',
                note: 'Реальное присутствие на экзамене, срок 2-4 недели',
                costPrice: 25000,
                lowerPrice: 50000,
                upperPrice: 65000,
                minMargin: 25000,
                fee: '',
                quantity: 1
              },
              {
                id: 'edu5',
                name: 'Промышленная Безопасность через комиссию ЕПТ (единый портал тестирования)',
                note: 'Дистанционная форма, срок 3 рабочих дня',
                costPrice: 6000,
                lowerPrice: 20000,
                upperPrice: 25000,
                minMargin: 14000,
                fee: '',
                quantity: 1
              },
              {
                id: 'edu6',
                name: 'Рабочие профессии по специальностям',
                note: 'Любые профессии, срок 1 раб. день',
                costPrice: 1500,
                lowerPrice: 6500,
                upperPrice: 8500,
                minMargin: 3000,
                fee: '',
                quantity: 1
              },
              {
                id: 'edu7',
                name: 'Профессиональная переподготовка (программы по запросу)',
                note: 'Запросить программу, обучаем только с высшим образованием, срок 3 раб дня',
                costPrice: 5500,
                lowerPrice: 15500,
                upperPrice: 20500,
                minMargin: 9500,
                fee: '',
                quantity: 1
              },
              {
                id: 'edu8',
                name: 'Электробезопасность 2 - 5 группа',
                costPrice: 25000,
                lowerPrice: 50000,
                upperPrice: 65000,
                minMargin: 25000,
                fee: '',
                quantity: 1,
                type: 'Присутствие',
                types: {
                  'Присутствие': { note: 'Присутствие в Челябинске (любая группа), срок 4 недели', cost: 25000, lower: 50000, upper: 65000, margin: 25000 },
                  'Дистанционно': { note: 'Дистанционно (стоимость за одну группу), срок 4-5 недели', cost: 40000, lower: 80000, upper: 95000, margin: 22000 }
                }
              }
            ]
          },
          {
            category: 'Лицензирование',
            items: [
              {
                id: 'lic1',
                name: 'Лицензия МЧС',
                note: 'Запросить у клиента регион и виды лицензируемой деятельности (их 9), 45 рабочих дней',
                costPrice: 10000,
                lowerPrice: 0,
                upperPrice: 0,
                minMargin: 0,
                fee: '',
                quantity: 1,
                customPrice: true
              },
              {
                id: 'lic2',
                name: 'МинКультуры',
                note: 'Запросить у клиента номера и количество лицензируемых направлений (11 направлений, от двух в запросе), 45 рабочих дней',
                costPrice: 200000,
                lowerPrice: 0,
                upperPrice: 0,
                minMargin: 0,
                fee: '',
                quantity: 1,
                customPrice: true
              },
              {
                id: 'lic3',
                name: 'Электролаборатория',
                note: 'Запросить класс напряжения для лицензирования, срок до 35 рабочих дней',
                costPrice: 55000,
                lowerPrice: 0,
                upperPrice: 0,
                minMargin: 0,
                fee: '',
                quantity: 1,
                customPrice: true
              }
            ]
          },
          {
            category: 'ISO',
            items: [
              {
                id: 'iso1',
                name: 'ISO 9001, 14001, 18001, 22000, 51705.1',
                note: 'Цена за каждый из перечисленных, срок 2 дня',
                costPrice: 1500,
                lowerPrice: 15000,
                upperPrice: 25000,
                minMargin: 13500,
                fee: '',
                quantity: 1
              },
              {
                id: 'iso2',
                name: 'Интегрированная система ISO (3 сертификата из списка)',
                note: 'Цена за три сертификата, срок 2-3 дня',
                costPrice: 4500,
                lowerPrice: 30000,
                upperPrice: 50000,
                minMargin: 20500,
                fee: '',
                quantity: 1
              }
            ]
          },
          {
            category: 'ВИК',
            items: [
              {
                id: 'vik1',
                name: 'Аттестация ЛНК ( ВИК, РК, ЛК, УК, МК)',
                note: 'Заполнить заявку, срок 45 дней',
                costPrice: 17000,
                lowerPrice: 0,
                upperPrice: 0,
                minMargin: 0,
                fee: '',
                quantity: 1,
                customPrice: true
              }
            ]
          },
          {
            category: 'СОУТ',
            items: [
              {
                id: 'sout1',
                name: 'Подготовка пакета документов на аттестацию рабочих мест всех заявленных специалистов',
                note: 'Разработка штатного расписания, срок 2-3 дня',
                costPrice: 0,
                lowerPrice: 5000,
                upperPrice: 6000,
                minMargin: 5000,
                fee: '',
                quantity: 1
              },
              {
                id: 'sout2',
                name: 'СОУТ 1-5 рабочих мест',
                note: 'Просчет по штатному расписанию за пакет, срок 3 недели',
                costPrice: 3000,
                lowerPrice: 0,
                upperPrice: 0,
                minMargin: 0,
                fee: '',
                quantity: 1,
                customPrice: true
              },
              {
                id: 'sout3',
                name: 'СОУТ от 6 до 10 рабочих мест',
                note: 'Просчет по штатному расписанию за пакет, срок 3 недели',
                costPrice: 10000,
                lowerPrice: 0,
                upperPrice: 0,
                minMargin: 0,
                fee: '',
                quantity: 1,
                customPrice: true
              },
              {
                id: 'sout4',
                name: 'СОУТ от 11 и выше',
                note: 'Просчет по штатному расписанию за одно РМ, срок 3 недели',
                costPrice: 700,
                lowerPrice: 0,
                upperPrice: 0,
                minMargin: 0,
                fee: '',
                quantity: 1,
                customPrice: true
              }
            ]
          }
        ];

        setServices(servicesData);
        setActiveCategory(servicesData[0].category);
      }, []);

      React.useEffect(() => {
        // Calculate total price when selected services change
        let total = 0;
        selectedServices.forEach(service => {
          // Use manual price if available, otherwise use middle of price range
          let price;
          if (service.customPrice) {
            if (service.customPrice === true) {
              price = 0; // For services with "Индивидуальный расчет" that haven't been set
            } else if (typeof service.customPrice === 'object') {
              price = service.customPrice.current;
            } else if (typeof service.customPrice === 'string') {
              price = parseFloat(service.customPrice) || 0;
            } else {
              price = service.customPrice;
            }
          } else if (service.manualPrice !== undefined) {
            price = service.manualPrice;
          } else {
            price = (service.lowerPrice + service.upperPrice) / 2;
          }
          total += price * service.quantity;
        });
        setTotalPrice(total);
      }, [selectedServices]);

      const handleAddService = (item, subItem = null) => {
        const serviceToAdd = subItem ? { ...subItem, parentName: item.name } : { ...item };
        
        // Set manual price equal to the middle of range by default
        if (!serviceToAdd.customPrice) {
          serviceToAdd.manualPrice = (serviceToAdd.lowerPrice + serviceToAdd.upperPrice) / 2;
        } else if (serviceToAdd.customPrice === true) {
          // Для услуг с индивидуальным расчетом устанавливаем начальные значения
          serviceToAdd.customPrice = {
            current: 0,
            min: 0,
            max: 1000000
          };
        }
        
        // Check if service already exists in selected services
        const existingServiceIndex = selectedServices.findIndex(s => 
          s.id === serviceToAdd.id
        );

        if (existingServiceIndex !== -1) {
          // Update quantity if service already exists
          const updatedServices = [...selectedServices];
          updatedServices[existingServiceIndex].quantity += 1;
          setSelectedServices(updatedServices);
        } else {
          // Add new service
          setSelectedServices([...selectedServices, serviceToAdd]);
        }
      };

      const handleRemoveService = (id) => {
        setSelectedServices(selectedServices.filter(service => service.id !== id));
      };

      const handleQuantityChange = (id, newQuantity) => {
        if (newQuantity < 1) return;
        
        const updatedServices = selectedServices.map(service => 
          service.id === id ? { ...service, quantity: newQuantity } : service
        );
        
        setSelectedServices(updatedServices);
      };

      const handleRegionChange = (id, newRegion) => {
        const updatedServices = selectedServices.map(service => {
          if (service.id === id && service.priceByRegion) {
            const updatedService = { ...service, region: newRegion };
            if (service.priceByRegion[newRegion]) {
              updatedService.lowerPrice = service.priceByRegion[newRegion].lower;
              updatedService.upperPrice = service.priceByRegion[newRegion].upper;
            }
            if (service.noteByRegion && service.noteByRegion[newRegion]) {
              updatedService.note = service.noteByRegion[newRegion];
            }
            if (service.manualPrice === undefined) {
              updatedService.manualPrice = (updatedService.lowerPrice + updatedService.upperPrice) / 2;
            }
            return updatedService;
          }
          return service;
        });
        
        setSelectedServices(updatedServices);
      };

      const handleCityChange = (id, newCity) => {
        const updatedServices = selectedServices.map(service => {
          if (service.id === id && service.cities) {
            const cityData = service.cities[newCity];
            if (cityData) {
              const updatedService = { 
                ...service, 
                city: newCity,
                costPrice: cityData.cost,
                lowerPrice: cityData.lower,
                upperPrice: cityData.upper,
                minMargin: cityData.margin
              };
              if (service.manualPrice === undefined) {
                updatedService.manualPrice = (updatedService.lowerPrice + updatedService.upperPrice) / 2;
              }
              return updatedService;
            }
            return { ...service, city: newCity };
          }
          return service;
        });
        
        setSelectedServices(updatedServices);
      };

      const handleTypeChange = (id, newType) => {
        const updatedServices = selectedServices.map(service => {
          if (service.id === id && service.types && service.types[newType]) {
            const typeData = service.types[newType];
            const updatedService = { 
              ...service, 
              type: newType,
              costPrice: typeData.cost || service.costPrice,
              lowerPrice: typeData.lower,
              upperPrice: typeData.upper,
              minMargin: typeData.margin || service.minMargin,
              note: typeData.note || service.note
            };
            if (service.manualPrice === undefined) {
              updatedService.manualPrice = (updatedService.lowerPrice + updatedService.upperPrice) / 2;
            }
            return updatedService;
          }
          return service;
        });
        
        setSelectedServices(updatedServices);
      };

      const handleCustomPriceChange = (id, price, type = 'current') => {
        const updatedServices = selectedServices.map(service => {
          if (service.id === id) {
            if (typeof service.customPrice === 'object') {
              // Для объектного представления цены (слайдер + ввод)
              return { 
                ...service, 
                customPrice: {
                  ...service.customPrice,
                  [type]: type === 'current' ? Number(price) || 0 : price
                } 
              };
            }
            // Обратная совместимость со старым форматом
            return { ...service, customPrice: price };
          }
          return service;
        });
        
        setSelectedServices(updatedServices);
      };
      
      const handleManualPriceChange = (id, price) => {
        const updatedServices = selectedServices.map(service => {
          if (service.id === id) {
            // Ensure price is within allowed range
            const validatedPrice = Math.min(
              Math.max(price, service.lowerPrice),
              service.upperPrice
            );
            return { ...service, manualPrice: validatedPrice };
          }
          return service;
        });
        
        setSelectedServices(updatedServices);
      };

      const formatPrice = (price) => {
        return new Intl.NumberFormat('ru-RU').format(price);
      };
      
      const copyToClipboard = () => {
        if (proposalRef.current) {
          const range = document.createRange();
          range.selectNode(proposalRef.current);
          window.getSelection().removeAllRanges();
          window.getSelection().addRange(range);
          document.execCommand('copy');
          window.getSelection().removeAllRanges();
          alert('Предложение скопировано в буфер обмена!');
        }
      };
      
      const generateProposal = () => {
        if (selectedServices.length === 0) {
          alert('Необходимо выбрать хотя бы одну услугу!');
          return;
        }
        
        let proposal = 'КОММЕРЧЕСКОЕ ПРЕДЛОЖЕНИЕ\n\n';
        proposal += 'Предлагаем вам следующие услуги:\n\n';
        
        selectedServices.forEach((service, index) => {
          const serviceName = service.parentName 
            ? `${service.parentName} - ${service.name}`
            : service.name;
          
          let price;
          if (service.customPrice) {
            if (service.customPrice === true) {
              price = 'Индивидуальный расчет';
            } else if (typeof service.customPrice === 'object') {
              price = service.customPrice.current;
            } else if (typeof service.customPrice === 'string') {
              price = parseFloat(service.customPrice) || 0;
            } else {
              price = service.customPrice;
            }
          } else if (service.manualPrice !== undefined) {
            price = service.manualPrice;
          } else {
            price = (service.lowerPrice + service.upperPrice) / 2;
          }
          
          const formattedPrice = typeof price === 'number' 
            ? formatPrice(price) + ' ₽'
            : price;
          
          proposal += `${index + 1}. ${serviceName}\n`;
          proposal += `   Количество: ${service.quantity}\n`;
          proposal += `   Стоимость: ${formattedPrice}`;
          
          if (service.note) {
            proposal += `\n   Примечание: ${service.note}`;
          }
          
          if (service.region) {
            proposal += `\n   Регион: ${service.region}`;
          }
          
          if (service.city) {
            proposal += `\n   Город: ${service.city}`;
          }
          
          if (service.fee) {
            proposal += `\n   Дополнительно: ${service.fee}`;
          }
          
          proposal += '\n\n';
        });
        
        proposal += `Общая стоимость: ${formatPrice(totalPrice)} ₽\n\n`;
        proposal += 'Срок действия предложения: 14 дней\n';
        proposal += 'По всем вопросам обращайтесь по телефону: +7 (XXX) XXX-XX-XX';
        
        setProposalText(proposal);
        setShowProposal(true);
      };

      const filteredServices = services.map(category => ({
        ...category,
        items: category.items.filter(item => {
          if (!searchTerm) return true;
          return item.name.toLowerCase().includes(searchTerm.toLowerCase());
        })
      })).filter(category => category.items.length > 0);

      return (
        <div className="flex flex-col min-h-screen bg-gray-50">
          <header className="bg-blue-600 text-white shadow-lg">
            <div className="container mx-auto py-4 px-4">
              <h1 className="text-2xl font-bold">Калькулятор услуг</h1>
              <p className="text-blue-100">Расчет стоимости услуг для клиентов</p>
            </div>
          </header>
          
          {showProposal ? (
            <div className="container mx-auto p-4 bg-white mt-4 rounded-lg shadow-md">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold">Сформированное предложение</h2>
                <div className="space-x-2">
                  <button 
                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
                    onClick={copyToClipboard}
                  >
                    Копировать
                  </button>
                  <button 
                    className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition"
                    onClick={() => setShowProposal(false)}
                  >
                    Вернуться к калькулятору
                  </button>
                </div>
              </div>
              <div 
                ref={proposalRef}
                className="p-4 border border-gray-300 rounded-lg whitespace-pre-wrap bg-gray-50 font-mono text-sm"
              >
                {proposalText}
              </div>
            </div>
          ) : (
            <div className="container mx-auto p-4 flex-grow flex flex-col md:flex-row gap-6">
              <div className="w-full md:w-2/3 bg-white rounded-lg shadow-md p-4">
                <div className="mb-4">
                  <div className="flex items-center mb-4">
                    <input
                      type="text"
                      placeholder="Поиск услуг..."
                      className="w-full p-2 border border-gray-300 rounded-md"
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                    />
                    <button 
                      className="ml-2 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition"
                      onClick={() => setIsPriceListVisible(!isPriceListVisible)}
                    >
                      {isPriceListVisible ? 'Скрыть прайс' : 'Показать прайс'}
                    </button>
                  </div>
                  
                  {isPriceListVisible && (
                    <div className="mb-4 overflow-x-auto">
                      <table className="min-w-full border-collapse border border-gray-300">
                        <thead>
                          <tr className="bg-gray-100">
                            <th className="border border-gray-300 px-2 py-1 text-xs">Услуга</th>
                            <th className="border border-gray-300 px-2 py-1 text-xs">Примечание</th>
                            <th className="border border-gray-300 px-2 py-1 text-xs">Нижний предел</th>
                            <th className="border border-gray-300 px-2 py-1 text-xs">Верхний предел</th>
                            <th className="border border-gray-300 px-2 py-1 text-xs">Действие</th>
                          </tr>
                        </thead>
                        <tbody>
                          {services.map(category => (
                            category.items.map(item => (
                              item.subItems ? 
                                item.subItems.map(subItem => (
                                  <tr key={subItem.id} className="border-b border-gray-300">
                                    <td className="border border-gray-300 px-2 py-1 text-xs">{item.name} - {subItem.name}</td>
                                    <td className="border border-gray-300 px-2 py-1 text-xs">{subItem.note || item.note || '-'}</td>
                                    <td className="border border-gray-300 px-2 py-1 text-xs">{subItem.lowerPrice ? formatPrice(subItem.lowerPrice) : '-'}</td>
                                    <td className="border border-gray-300 px-2 py-1 text-xs">{subItem.upperPrice ? formatPrice(subItem.upperPrice) : '-'}</td>
                                    <td className="border border-gray-300 px-2 py-1 text-xs">
                                      <button 
                                        className="bg-green-500 text-white px-2 py-1 rounded-sm text-xs hover:bg-green-600 transition"
                                        onClick={() => handleAddService(item, subItem)}
                                      >
                                        Добавить
                                      </button>
                                    </td>
                                  </tr>
                                ))
                              :
                              <tr key={item.id} className="border-b border-gray-300">
                                <td className="border border-gray-300 px-2 py-1 text-xs">{item.name}</td>
                                <td className="border border-gray-300 px-2 py-1 text-xs">{item.note || '-'}</td>
                                <td className="border border-gray-300 px-2 py-1 text-xs">{item.lowerPrice ? formatPrice(item.lowerPrice) : '-'}</td>
                                <td className="border border-gray-300 px-2 py-1 text-xs">{item.upperPrice ? formatPrice(item.upperPrice) : '-'}</td>
                                <td className="border border-gray-300 px-2 py-1 text-xs">
                                  <button 
                                    className="bg-green-500 text-white px-2 py-1 rounded-sm text-xs hover:bg-green-600 transition"
                                    onClick={() => handleAddService(item)}
                                  >
                                    Добавить
                                  </button>
                                </td>
                              </tr>
                            ))
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                  
                  <div className="flex space-x-2 overflow-x-auto pb-2">
                    {services.map(category => (
                      <button
                        key={category.category}
                        className={`px-3 py-2 rounded-md whitespace-nowrap ${
                          activeCategory === category.category
                            ? 'bg-blue-600 text-white'
                            : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                        }`}
                        onClick={() => setActiveCategory(category.category)}
                      >
                        {category.category}
                      </button>
                    ))}
                  </div>
                </div>
                
                <div className="space-y-4">
                  {filteredServices.map(category => (
                    <div 
                      key={category.category} 
                      className={`${activeCategory === category.category ? 'block' : 'hidden'}`}
                    >
                      <h2 className="text-lg font-semibold mb-2">{category.category}</h2>
                      <div className="space-y-3">
                        {category.items.map(item => (
                          <div key={item.id} className="border border-gray-200 rounded-md p-3 hover:border-blue-300 transition">
                            <h3 className="font-medium">{item.name}</h3>
                            {item.note && <p className="text-sm text-gray-600 mt-1">{item.note}</p>}
                            
                            {item.subItems ? (
                              <div className="mt-2 space-y-2">
                                {item.subItems.map(subItem => (
                                  <div key={subItem.id} className="flex justify-between items-center bg-gray-50 p-2 rounded">
                                    <div>
                                      <p className="text-sm">{subItem.name}</p>
                                      <p className="text-xs text-gray-500">
                                        {formatPrice(subItem.lowerPrice)} - {formatPrice(subItem.upperPrice)} ₽
                                      </p>
                                    </div>
                                    <button
                                      className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 transition text-sm"
                                      onClick={() => handleAddService(item, subItem)}
                                    >
                                      Добавить
                                    </button>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <div className="flex justify-between items-center mt-2">
                                <p className="text-sm">
                                  {item.customPrice === true 
                                    ? "Индивидуальный расчет"
                                    : `${formatPrice(item.lowerPrice)} - ${formatPrice(item.upperPrice)} ₽`}
                                </p>
                                <button
                                  className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 transition text-sm"
                                  onClick={() => handleAddService(item)}
                                >
                                  Добавить
                                </button>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
              
              <div className="w-full md:w-1/3">
                <div className="bg-white rounded-lg shadow-md p-4 sticky top-4">
                  <h2 className="text-lg font-semibold mb-4">Выбранные услуги</h2>
                  
                  {selectedServices.length === 0 ? (
                    <p className="text-gray-500 italic">Нет выбранных услуг</p>
                  ) : (
                    <div className="space-y-4">
                      {selectedServices.map(service => (
                        <div key={service.id} className="border border-gray-200 rounded-md p-3">
                          <div className="flex justify-between">
                            <h3 className="font-medium text-sm">
                              {service.parentName ? `${service.parentName} - ${service.name}` : service.name}
                            </h3>
                            <button
                              className="text-red-500 hover:text-red-700"
                              onClick={() => handleRemoveService(service.id)}
                            >
                              ✕
                            </button>
                          </div>
                          
                          <div className="mt-2 space-y-2">
                            {service.regions && (
                              <div className="flex items-center">
                                <label className="text-xs text-gray-600 w-24">Регион:</label>
                                <select
                                  className="text-xs p-1 border border-gray-300 rounded w-full"
                                  value={service.region}
                                  onChange={(e) => handleRegionChange(service.id, e.target.value)}
                                >
                                  {service.regions.map(region => (
                                    <option key={region} value={region}>{region}</option>
                                  ))}
                                </select>
                              </div>
                            )}
                            {service.regionNotes && service.regionNotes[service.region] && (
                              <div className="text-xs text-gray-600 mt-1 ml-24">
                                <span className="font-medium">Список регионов:</span> {service.regionNotes[service.region]}
                              </div>
                            )}
                            
                            {service.cities && (
                              <div className="flex items-center">
                                <label className="text-xs text-gray-600 w-24">Город:</label>
                                <select
                                  className="text-xs p-1 border border-gray-300 rounded w-full"
                                  value={service.city}
                                  onChange={(e) => handleCityChange(service.id, e.target.value)}
                                >
                                  {Object.keys(service.cities).map(city => (
                                    <option key={city} value={city}>{city}</option>
                                  ))}
                                </select>
                              </div>
                            )}
                            
                            {service.types && (
                              <div className="flex items-center">
                                <label className="text-xs text-gray-600 w-24">Тип:</label>
                                <select
                                  className="text-xs p-1 border border-gray-300 rounded w-full"
                                  value={service.type}
                                  onChange={(e) => handleTypeChange(service.id, e.target.value)}
                                >
                                  {Object.keys(service.types).map(type => (
                                    <option key={type} value={type}>{type}</option>
                                  ))}
                                </select>
                              </div>
                            )}
                            
                            <div className="flex items-center">
                              <label className="text-xs text-gray-600 w-24">Количество:</label>
                              <div className="flex items-center">
                                <button
                                  className="bg-gray-200 px-2 py-1 rounded-l"
                                  onClick={() => handleQuantityChange(service.id, service.quantity - 1)}
                                >
                                  -
                                </button>
                                <input
                                  type="number"
                                  className="w-12 text-center border-t border-b border-gray-300"
                                  value={service.quantity}
                                  onChange={(e) => handleQuantityChange(service.id, parseInt(e.target.value) || 1)}
                                  min="1"
                                />
                                <button
                                  className="bg-gray-200 px-2 py-1 rounded-r"
                                  onClick={() => handleQuantityChange(service.id, service.quantity + 1)}
                                >
                                  +
                                </button>
                              </div>
                            </div>
                            
                            {service.customPrice && typeof service.customPrice === 'object' && (
                              <div>
                                <div className="flex items-center">
                                  <label className="text-xs text-gray-600 w-24">Диапазон цен:</label>
                                  <span className="text-xs">
                                    {formatPrice(service.customPrice.min)} - {formatPrice(service.customPrice.max)} ₽
                                  </span>
                                </div>
                                <div className="flex items-center mt-1">
                                  <label className="text-xs text-gray-600 w-24">Цена (₽):</label>
                                  <input
                                    type="range"
                                    className="w-full custom-range"
                                    min={service.customPrice.min}
                                    max={service.customPrice.max}
                                    step={100}
                                    value={service.customPrice.current}
                                    onChange={(e) => handleCustomPriceChange(service.id, parseInt(e.target.value), 'current')}
                                  />
                                  <input
                                    type="number"
                                    className="text-xs p-1 border border-gray-300 rounded ml-2 w-20"
                                    value={service.customPrice.current}
                                    onChange={(e) => handleCustomPriceChange(service.id, parseInt(e.target.value) || 0, 'current')}
                                    min={service.customPrice.min}
                                    max={service.customPrice.max}
                                  />
                                </div>
                                <div className="flex items-center mt-1">
                                  <label className="text-xs text-gray-600 w-24">Мин. цена:</label>
                                  <input
                                    type="number"
                                    className="text-xs p-1 border border-gray-300 rounded w-20"
                                    value={service.customPrice.min}
                                    onChange={(e) => handleCustomPriceChange(service.id, parseInt(e.target.value) || 0, 'min')}
                                  />
                                  <label className="text-xs text-gray-600 ml-2 mr-1">Макс. цена:</label>
                                  <input
                                    type="number"
                                    className="text-xs p-1 border border-gray-300 rounded w-20"
                                    value={service.customPrice.max}
                                    onChange={(e) => handleCustomPriceChange(service.id, parseInt(e.target.value) || 0, 'max')}
                                  />
                                </div>
                              </div>
                            )}
                            
                            {service.customPrice && service.customPrice !== true && typeof service.customPrice !== 'object' && (
                              <div className="flex items-center">
                                <label className="text-xs text-gray-600 w-24">Цена (₽):</label>
                                <input
                                  type="text"
                                  inputMode="numeric"
                                  pattern="[0-9]*"
                                  className="text-xs p-1 border border-gray-300 rounded w-full"
                                  placeholder="Введите стоимость"
                                  value={service.customPrice}
                                  onChange={(e) => handleCustomPriceChange(service.id, e.target.value)}
                                />
                              </div>
                            )}
                            
                            {!service.customPrice && (
                              <div>
                                <div className="flex items-center">
                                  <label className="text-xs text-gray-600 w-24">Диапазон цен:</label>
                                  <span className="text-xs">
                                    {formatPrice(service.lowerPrice)} - {formatPrice(service.upperPrice)} ₽
                                  </span>
                                </div>
                                <div className="flex items-center mt-1">
                                  <label className="text-xs text-gray-600 w-24">Цена (₽):</label>
                                  <input
                                    type="range"
                                    className="w-full custom-range"
                                    min={service.lowerPrice}
                                    max={service.upperPrice}
                                    step={100}
                                    value={service.manualPrice || (service.lowerPrice + service.upperPrice) / 2}
                                    onChange={(e) => handleManualPriceChange(service.id, parseInt(e.target.value))}
                                  />
                                  <input
                                    type="number"
                                    className="text-xs p-1 border border-gray-300 rounded ml-2 w-20"
                                    value={service.manualPrice || (service.lowerPrice + service.upperPrice) / 2}
                                    onChange={(e) => handleManualPriceChange(service.id, parseInt(e.target.value) || service.lowerPrice)}
                                    min={service.lowerPrice}
                                    max={service.upperPrice}
                                  />
                                </div>
                              </div>
                            )}
                            
                            {service.fee && (
                              <div className="flex items-center">
                                <label className="text-xs text-gray-600 w-24">Пошлина:</label>
                                <span className="text-xs">{service.fee}</span>
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                      
                      <div className="border-t pt-4 mt-4">
                        <div className="flex justify-between items-center">
                          <h3 className="font-semibold">Итого:</h3>
                          <span className="text-xl font-bold text-blue-600">{formatPrice(totalPrice)} ₽</span>
                        </div>
                        
                        <button
                          className="w-full mt-4 bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition font-medium"
                          onClick={generateProposal}
                        >
                          Сформировать предложение
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}
          
          <footer className="bg-gray-800 text-white py-4 mt-8">
            <div className="container mx-auto px-4">
              <div className="flex flex-col md:flex-row justify-between items-center">
                <div>
                  <p className="text-sm text-gray-300">© 2025 Калькулятор услуг</p>
                </div>
              </div>
            </div>
          </footer>
        </div>
      );
    };

    // Рендерим приложение
    ReactDOM.render(<ServiceCalculator />, document.getElementById('root'));
  </script>
</body>
</html>